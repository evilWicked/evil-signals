<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>evil signals: markdown/design-ideas-signals.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">evil signals
   </div>
   <div id="projectbrief">Lightweight Cross Platform Signals and Slots Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">markdown/design-ideas-signals.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="design-ideas-signals_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Design Ideas: Signals                       {#designsignals}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;===========================</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;A can of worms...</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;-----------------</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Supporting Signals and Slots looked to be an easy implementation until reality dawned upon a pitfall filled world of complex pain. To see why consider the basic idea of a class (a signal) that calls a list of callbacks when required.  With C++11 bind and lambdas this is fairly straight forward. Nothing like the ease of doing it in Javascript but achievable.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;Before we start though, imagine for a second a signal between two sprites. A mouse click on a sprite causes some change we would like to propogate to another sprite. Easy as! just a callback eh.</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;What happens if the second sprite has been deleted....?  </div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;How does the first sprite know?</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;OK lets say we keep a list of all signals that are being sent to an object so that when we delete the object we can tell the signals not try to talk to an object thats not there.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;What happens if the first sprite was deleted prior to this....?</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;To handle just this little piece of the problem we need the following.</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;Requirements</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;------------</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;- The source of a signal and the target of a signal must be aware of the other.</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;- If the target of a signal no longer exists the source must no longer attempt to send to it.</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  + *This is equivalent to requiring that if the target of a signal is removed than it must communicate this to the source.*</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;- If the source of a signal no longer exists the target must no longer attempt to communicate with it.</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  + *This is equivalent to requiring that if the source of a signal is removed than it must communicate this to the target.*</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  </div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;Solution</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;--------</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;After trying various attempts it became clear that we need the following as a minimum.</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;1. A Signal Class (CSignal) That generates signals as well as maintains and manages a list of slots</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;that the signal calls.</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;2. The Signal class must inform any connected slot that it is being removed.  </div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;3. The Signal class must not attempt to communicate with a deleted slot.</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;4. A Slot Class (CSlot) that provides the binding between the between the signal and the actual function being called. </div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;5. The Slot class must inform the connected signal that it is being deleted. </div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;6. The Slot class must not attempt to communicate with a deleted signal. </div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;7. It is up to the object holding the signal/slot to remove the signal/slot if is no longer required.</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;There are other features of the solution - but they are not essential to the basic requirements above.</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;Threading</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;---------</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;Thread Safety:  You want what? ROFL!!....</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;Ok it has thread support built in - but do you really know what you are asking for?  Think again.</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;### Scenarios </div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;1. A single signal on a single thread calling different slots on multiple threads.</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;2. A single signal on multiple threads talking to the same slot.</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;3. A single signal on a single thread talking to a single slot on multiple threads.</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;4. A single signal on multiple threads talking to a single slot on multiple threads. </div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;5. Changing the state of a signal from several threads (not receiving a signal - which doesn&#39;t change state).</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;6. Changing the state a slot from several threads (not sending a signal - which doesn&#39;t change state).</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;Multiple signals talking to a single slot does not exist at all so we can ignore all these options.</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;The only real solution I have in mind is 1.  the situation where you have a signal sending to different slots</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;on different threads.  </div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;For all the rest you can try, but lets just say your mileage may vary.....</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;### Built In Mutex Support</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;To cover any situation where you have mutiple threads interacting with a single signal you need to enable lock guards on the signal.</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    signal.useLockGuards(true); </div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;It defaults to false. </div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;This will cover adding and removing slots from multiple threads as well as changing thread priorities. Deleting the signal itself or parent object is your design problem.  The signal when deleted will tell all connected slots that it gone.  Sending a signal does not change state.</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;*The exception to the above: The signal.addOnce() functionality sends a signal to a slot and then removes the slot. It is intended to handle one shot events.*</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;To cover any situation where you have mutiple threads interacting with a single slot you need to enable lock guards on the slot.</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    slot.useLockGuards(true); </div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;   </div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;It also defaults to false.</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;This is probably a rare situation and I really don&#39;t like thinking about the mess of deleting a single slot that is on multiple threads.  But if you want to try it&#39;s there.</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;Problems</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;---------</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;Before you get all excited consider the following discussion - threading is inherently nasty even with mutexes.</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;   </div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;Imagine a game in which we have a collection of sprites communicating using signals. Give the sprites a rule in which if the health of a sprite drops below a certain amount a signal is fired off to other sprites to ask them to do something. One of the other sprites fires off a heal the other a health buff. </div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;The sprites are distinct objects so we think think we will be clever and use different threads.</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;We have two scenarios. In one the Heal gets there first and then the Buff arrives. In the other case the Buff gets there first and then the Heal.</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;In the first we have </div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;&lt;CENTER&gt;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;\f$ BaseHealth := ( BaseHealth + Heal ) * HealthBoost \f$</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;&lt;/CENTER&gt;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;In the second we have </div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;&lt;CENTER&gt; </div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;\f$ BaseHealth := BaseHealth*HealthBoost + Heal\f$  </div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;&lt;/CENTER&gt;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;The trouble is that these are not equal </div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;&lt;CENTER&gt; </div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;\f$ (BaseHealth+Heal)*HealthBoost \neq BaseHealth*HealthBoost+Heal \f$</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;&lt;/CENTER&gt; </div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;In my particular scenario where this library exists as a larger component in an audio processing library it would mean</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;that a volume effect would produce different outputs depending on thread timing.</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;&lt;CENTER&gt; </div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; \f$(BaseVol+VolChange)*Amplify \neq VolChange+Amplify*BaseVol \f$</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;&lt;/CENTER&gt; </div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;Note that none of this had anything to do with Mutex locks. It is due to the fact that in general state changes to objects are non abelian. In other words in general unlike familiar things like numbers state changes don&#39;t swap \f$ A*B \neq B*A \f$</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;Mathematically it is the same as \f$ f1(f2(x)) \neq f2(f1(x)) \f$  which in the above translates to  \f$(A+C)*B \neq  A*B+C\f$  </div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;**Does that mean I can&#39;t multi thread?**</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;No it means I am not going to state that signals are thread safe - mutexes or not. I have built in support to enable signals and slots to be accessed from different threads. In particular a single thread talking to different slots on different threads.  This is only a small subset of all the possible scenarios and even then needs to be carefully thought about. </div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;It is your responsibility to handle deleting objects that contain either signals or slots. Internally signals never delete slots and slots never delete signals. They just drop their internal references. Internally I am not using smart pointers which means I am not incrementing any reference counts if you decide to use them. When a slot or a signal is deleted it will inform its counterpart.</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;Design Features That May Impact Threading.</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;-----------------------------------------</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;Both signals and slots maintain references (pointers in fact) to the other.  A Signal maintains a list of slots it is talking to. A slot maintains a pointer back to the signal it is listening for.  When a signal is deleted - most likely because the object containing the signal - such as a sprite - is deleted then all slots on that signal drop their reference back to the signal.</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;Similiarly when a slot (or the object containing it) is deleted, the slot tells the connected signal to remove its</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;reference to that slot so that it won&#39;t attempt to talk to it.</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;To be safe I would avoid any situation where the same signal is on two threads or the same slot is on two threads.</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;What should be fine (with careful thought) is when a signal is talking to two different slots that live on different threads. In that case deletion of one slot won&#39;t affect the other and deletion of the signal will occur in both places at once as it should.</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;In any case where the causal flow of your application results in simultaneous activities down different paths that produce different results and will combine at some point on a single object then the non abelian nature of state change IS going to bite you.</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;       </div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;Consider other operations outside signalling. Deleting objects containing a signal or slot. Passing objects by value.</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;Are you doing it? Why are you doing it? What is &#39;const &amp;&#39; for? Do you know what would happen when the scope of the  function ends and the now copied object phones home to its counterpart to say goodbye...?  Just don&#39;t do it.</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;Restrict your threads for tasks that can clearly be independently broken out. Don&#39;t try and be clever it&#39;s just too hard.</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
